function drawChart(t){t=d3.nest().key(function(t){return t.year}).entries(t),t.forEach(function(t){t.finishers=t.values[0].finishers,t.starters=t.values[0].starters}),console.log(t),barchart=d3.select("#allRacesChart").append("svg").attr("class","bars").attr("width",width).attr("height",height),barchart.append("text").attrs({y:chartLabelY,x:0,class:"liteGray label"}).text("Year"),barchart.append("text").attrs({y:chartLabelY,x:margin.left,class:"liteGray label"}).text("DNF"),barchart.append("text").attrs({y:chartLabelY,x:margin.left+30,class:"red label"}).text("Finishers"),bars=barchart.selectAll("g").data(t).enter().append("g").attr("transform",function(t){return"translate(0,"+yScale(t.key)+")"}),bars.append("rect").attrs({x:margin.left,y:0,width:width+margin.right,height:barHeight,class:function(t){return"y"+t.key+" darkGray"},opacity:0}).on("mouseover",raceOn()).on("mouseout",raceOff());var e;bars.append("rect").attrs({class:"dnf",x:margin.left,y:0,height:barHeight,width:function(t){return+t.starters-+t.finishers}}).on("mouseover",raceOn()).on("mouseout",raceOff()),bars.append("rect").attrs({class:"finishers",x:function(t){var e=+t.starters-+t.finishers;return isNaN(e)?margin.left:e+margin.left},y:0,height:barHeight,width:function(t){return+t.finishers}}).on("mouseover",raceOn()).on("mouseout",raceOff()),bars.append("text").attrs({class:"year",x:0,y:barHeight}).text(function(t){if(t.key%5==0||1896==t.key)return t.key});var a=d3.select("#allRacesChart").append("svg").attrs({class:"speed",width:wSpeed,height:hSpeed});a.append("text").attrs({x:0,y:chartLabelY,class:"liteGray label"}).text("Speed (km/hr)"),a.append("text").attrs({x:wSpeed,y:chartLabelY,class:"red label","text-anchor":"END"}).text("EACH FINISHING RACER IS MARKED BY A SINGLE RED LINE"),a.append("g").call(xAxis).attr("class","speeds x axis").attr("opacity",".5").attr("transform","translate(0,"+hSpeed+")");var r=a.selectAll("g.sYear").data(t).enter().append("g").attr("class",function(t){return"sYear y"+t.key}).attr("transform",function(t){return"translate(0,"+yScale(t.key)+")"});r.append("text").attrs({class:function(t){return"y"+t.key+" stats label liteGray hidden"},x:0,y:function(t){return t.key<1898?barHeight+12:-5},opacity:0}).text(function(t){var e=t.values[0].name+", ",a=t.values[0].country+", ",r=kmhr(t.values[0].kmPerSec)+"km/hr";return void 0==t.values[0].country&&(a=""),t.key+" Winner : "+e+a+r}),r.append("rect").attrs({x:0,y:0,width:wSpeed,height:barHeight,class:function(t){return"y"+t.key+" darkGray"},opacity:0}).on("mouseover",raceOn()).on("mouseout",raceOff()),r.selectAll("rect.speeds").data(function(t){return t.values}).enter().append("rect").attrs({class:"speeds",x:function(t){return xScaleSpeeds(3600*t.kmPerSec)},y:0,height:barHeight,width:1})}function raceOn(){return function(t){d3.selectAll("rect.y"+t.key).transition().duration(dura).attr("opacity",1),d3.select("text.y"+t.key).classed("hidden",!1).transition().duration(dura).attr("opacity",1),d3.select("g.y"+t.key).selectAll("rect.speeds").transition().duration(dura).attr("fill","#f2f2f2")}}function raceOff(){return function(t){d3.selectAll("rect.y"+t.key).transition().duration(dura).attr("opacity",0),d3.select("text.y"+t.key).classed("hidden",!0).transition().duration(dura).attr("opacity",0),d3.select("g.y"+t.key).selectAll("rect.speeds").transition().duration(dura).attr("fill","#f78056")}}function kmhr(t){return Math.ceil(3600*t)}var margin={top:20,right:10,bottom:5,left:45},width=300-margin.left-margin.right,height=1200-margin.top-margin.bottom,wSpeed=860-margin.left-margin.right;hSpeed=1200-margin.top-margin.bottom;var xScale=d3.scaleLinear().range([0,width]).domain([0,250]),xScaleSpeeds=d3.scaleLinear().range([0,wSpeed]).domain([0,45]),yScale=d3.scaleLinear().range([0,height]).domain([1896,2016]),xAxis=d3.axisTop().ticks(9).tickSize(hSpeed).scale(xScaleSpeeds),barHeight=6,chartLabelY=-20,dura=200;d3.json("data/parisRoubaix-fullv2.json",drawChart);